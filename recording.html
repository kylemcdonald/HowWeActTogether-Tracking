<html>
<head>
<meta charset="UTF-8">
<title>How We Act Together Recording</title>

<script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.4/p5.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.4/addons/p5.dom.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.16.5/lodash.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/clmtrackr/1.0.0/clmtrackr.js"></script>

<!-- 
<script src="libs/p5.min.js"></script>
<script src="libs/p5.dom.min.js"></script>
<script src="libs/lodash.min.js"></script>
<script src="libs/clmtrackr/clmtrackr.js"></script>
 -->

<script src="libs/model_pca_20_svm.js"></script>
<style>*{font-family: sans-serif;}</style>
</head>
<body style="background:gray">
<div id="recording"></div>
<script src="js/utils.js"></script>
<script>
var recordingSketch = function(p) {
	var u = new utils(p);

	var capture;
	var tracker;

	var w = 640, h = 480;
	var drawCamera = true;

	var prevPositions = [];
	var frameNumber = 0;
	var savedRecording = [];
	var recording = false;

	function loadRecording(filename) {
		p.loadJSON(filename, function(data) {
			savedRecording = data;
		});
	}

	p.keyPressed = function (key) {
		if(key.key == 'z') {
			u.resetTracker(tracker, capture);
		}
		if(key.key == 'x') {
			tracker.stop();
		}
		if(key.key == 'c') {
			drawCamera = !drawCamera;
		}
		// toggle recording
		if(key.key == 'r') {
			recording = !recording;
			if(recording) {
				savedRecording = [];
			}
		}
		// save recording
		if(key.key == 's') {
			p.writeFile([u.formatRecording(savedRecording)], 'recording.json');
		}
		// clear recording
		if(key.key == '0') {
			savedRecording = [];
		}
	}

	p.setup = function () {
		p.createCanvas(w, h);
		capture = p.createCapture(p.VIDEO);
		capture.size(w, h);
		capture.hide();
		tracker = createTracker(capture);
	}

	p.draw = function () {
		if(drawCamera) {
			p.image(capture, 0, 0, w, h);
		} else {
			p.background(0);
		}

		var positions = tracker.getCurrentPosition();
		var params = tracker.getCurrentParameters();

		if(positions.length > 0) {
			u.drawFace(positions, u.buildDescription(positions));
			// u.drawParameters(params);

			if(recording) {
				savedRecording.push(params.slice());   
			}
		}

		if(savedRecording.length > 0 && !recording) {
			var params = savedRecording[frameNumber % savedRecording.length];
			var positions = tracker.calculatePositions(params);
			u.drawFace(positions, u.buildDescription(positions));
		}

		frameNumber++;
	}
}

var interactivep5 = new p5(recordingSketch, 'recording');
</script>
</body>
</html>